// [jquery-console](http://neocotic.com/jquery-console) 1.0.0
// (c) 2011 Alasdair Mercer
// Freely distributable under the MIT license.
// For all details and documentation:
// http://neocotic.com/jquery-console
(function(a,b){var c={cd:{_args:[{name:"directory",optional:false}],_call:function(a){var b=this,c=b.data("console"),d=b.console("createMessageGroup"),e;if(a.length){e=a[0]}if(!e){b.console("printUsage",c.cmd.cd,"cd",d);d.addClass(c.completedClass);return}b.console("lookupManifest",e,function(a){if(a){c.vfsCd=a.path;b.console("createMessage","Working directory changed.","",d)}else{b.console("createMessage","cd: couldn't resolve path '"+e+"'",c.errorClass,d)}d.addClass(c.completedClass)})},_help:"change working directory"},clear:{_call:function(a,b){var c=this.data("console"),d=this.console("createMessageGroup");c.output.find("*").remove();c.callback();if(b.h.declared){c.history=[];c.historyIndex=-1}},_help:"clear all the messages from the console",_options:{h:{description:"clear command history"}}},help:{_args:[{name:"command",optional:true}],_call:function(b){var c=[],d=this.data("console"),e=[],f=0,g=this.console("createMessageGroup"),h="";if(b.length){e=this.console("lookupHints",b,true);if(e.length===1){if(e[0].usage){this.console("createMessage",e[0].usage,"",g)}}else if(!e.length){this.console("createMessage","help: command not found",d.errorClass,g)}else{this.console("createMessage","help: ambiguous command",d.errorClass,g)}}else{for(h in d.cmd){if(d.cmd.hasOwnProperty(h)){if(h[0]!=="_"){c.push({name:h,tip:d.cmd[h]._help})}}}c.sort(function(a,b){return a.name.localeCompare(b.name)});for(;f<c.length;f++){this.console("createMessage",a("<span/>").append(a("<a/>",{"data-cmd":c[f].name,tabindex:-1,text:c[f].name})).append("    "+c[f].tip),"",g)}}g.addClass(d.completedClass)},_help:"show general help information and a list of available "+"commands"},ls:{_args:[{name:"path",optional:true}],_call:function(a,b){var c=this,d=c.data("console"),e=c.console("createMessageGroup"),f="";if(a.length){f=a[0]}c.console("lookupManifest",f,function(a){var g=[],h=[],i=0,j="";if(a){g=Array.prototype.concat.call(a.directories,a.files);if(!g.length){c.console("createMessage",".<br/>..","",e);e.addClass(d.completedClass);return}for(;i<g.length;i++){j=g[i];if(j.indexOf(d.hiddenFilePrefix)===0){if(b.a.declared){if(d.hiddenFilePrefixMask){j=d.hiddenFilePrefixMask+j.substring(d.hiddenFilePrefix.length)}h.push(j)}}else{h.push(j)}}h.sort();for(i=0;i<h.length;i++){c.console("createMessage",h[i],"",e)}}else{c.console("createMessage",f+": No such file or directory",d.errorClass,e)}e.addClass(d.completedClass)})},_help:"list directory contents",_options:{a:{description:"include hidden files"}}},open:{_args:[{name:"file",optional:false}],_call:function(b){var c=this,d=c.data("console"),e,f=c.console("createMessageGroup"),g,h=-1,i="";if(b.length){g=b[0]}if(!g){c.console("printUsage",d.cmd.open,"open",f);f.addClass(d.completedClass);return}h=g.lastIndexOf("/");if(h!==-1){e=g.substring(h+1);i=g.substring(0,h)}else{e=g}if(!e){c.console("createMessage","open: must be valid file",d.errorClass,f);f.addClass(d.completedClass);return}c.console("lookupManifest",i,function(b){var h=0;if(b){var i=false,j=b.files,k={};if(e.indexOf(d.hiddenFilePrefix)===0){c.console("createMessage","open: couldn't resolve path '"+g+"'",d.errorClass,f);f.addClass(d.completedClass);return}if(e.indexOf(d.hiddenFilePrefixMask)===0){e=d.hiddenFilePrefix+e.substring(d.hiddenFilePrefixMask.length)}for(;h<j.length;h++){if(j[h]===e){i=true;break}}if(i){k=c.console("createMessage",d.loading,"",f);a.get(b.path+"/"+e,function(a){k.replace(a);f.addClass(d.completedClass)})}else{c.console("createMessage","open: couldn't resolve path '"+g+"'",d.errorClass,f);f.addClass(d.completedClass)}}else{c.console("createMessage","open: couldn't resolve path '"+g+"'",d.errorClass,f);f.addClass(d.completedClass)}})},_help:"open a file to view"},pwd:{_call:function(){var a=this.data("console");this.console("createMessageGroup",a.vfsCd).addClass(a.completedClass)},_help:"return working directory name"}};var d={addHistory:function(b){return this.each(function(){var c=a(this).data("console");c.history.push(b);c.historyIndex=-1})},callCommand:function(b){return this.each(function(){var c=a(this),d=c.data("console"),e=false,f=0,g={},h=d.cmd,i="";for(;f<b.length;f++){e=false;for(i in h){if(h.hasOwnProperty(i)){if(i===b[f]&&i[0]!=="_"){h=h[i];e=true;break}}}if(!e){break}}if(h!==d.cmd){if(h.hasOwnProperty("_call")){g=c.console("deriveCommandInput",h,Array.prototype.slice.call(b,f));if(g.error){c.console("createMessage",i+": "+g.error,d.errorClass);c.console("printUsage",h,i)}else{h._call.apply(c,[g.args,g.options])}}else if(h.hasOwnProperty("_usage")){c.console("createMessage",h._usage.apply(h),d.errorClass)}else{c.console("printUsage",h,i)}}else{c.console("createMessage","command not found",d.errorClass)}})},clone:function(a){var b,c=0,e="";if(!a||typeof a!=="object"){return a}if(a instanceof Date){b=new Date;b.setTime(a.getTime());return b}if(a instanceof Array){b=[];for(;c<a.length;c++){b[c]=d.clone(a[c])}return b}if(a instanceof Object){b={};for(e in a){if(a.hasOwnProperty(e)){b[e]=d.clone(a[e])}}return b}throw new Error("Unsupported object type")},createMessage:function(b,c,d){var e=this.data("console");b=b||"";c=c||"";var f={append:function(a){f.target.append(a||"");e.callback(f.target);return f},replace:function(a){f.target.html(a||"");e.callback(f.target);return f},target:a("<div/>",{"class":e.messageClass+" "+c,html:b})};if(d){d.append(f.target)}else{e.output.append(f.target)}e.callback(f.target);return f},createMessageGroup:function(b,c){var d=this.data("console"),e=a("<div/>",{"class":d.messageGroupClass});if(b){c=c||"";e.append(a("<div/>",{"class":d.messageClass+" "+c,html:b}))}d.output.append(e);d.callback(e);return e},deriveCommandInput:function(a,b){var c="",d=false,e=this.data("console"),f=0,g={args:[],error:"",options:{}},h=0,i={};if(a._options){g.options=this.console("clone",a._options);for(;f<b.length;f++){c=b[f];if(c.indexOf(e.optionPrefix)===0){i=g.options[c.substring(1)];if(i){i.declared=true}else{g.error("illegal option "+c);break}}else{d=false;if(i&&i.args){for(h=0;h<i.args.length;h++){if(!i.args[h].declared){i.args[h].declared=true;i.args[h].value=c;d=true;break}}}if(!d){g.args.push(c)}}}}else{g.args=b}return g},destroy:function(b){return this.each(function(){var c=a(this),d=c.data("console");d.hints.find("a[data-hint]").die(".console").remove();d.hints.hide();d.input.unbind(".console").val("");d.output.find("a[data-cmd]").die(".console");if(!b){d.output.find("div."+d.messageClass+", div."+d.messageGroupClass).remove()}c.removeData("console")})},findConsole:function(){var a=this.data("console");return a?this:d.findConsole.apply(this.parent())},findData:function(){var a=this.data("console");return a||d.findData.apply(this.parent())},getPrefix:function(){var a=this.data("console"),b="";if(a.prefixOverride){b+=a.prefixOverride}else{b+=a.username||"guest";b+=a.prefixSeperator;b+=a.vfsCd}b+=a.prefixSymbol;return b},getUsage:function(b,c){var d={},e=b._args,f=a("<div/>"),g=a("<span/>").appendTo(f),h="usage: "+c,i=a("<div/>").appendTo(f),j=0,k=0,l={},m="",n=b._options,o="",p=a("<table/>").css("margin-left",30);if(n){i.append("options:");for(o in n){if(n.hasOwnProperty(o)){l=n[o];m="";if(l.args){for(j=0;j<l.args.length;j++){m+="<em>"+l.args[j].name+"</em>, "}if(m){m=m.substring(0,m.length-2)}}h+=" [-"+o;if(m){h+=" "+m}h+="]";a("<tr/>").append(a("<td/>",{html:"-"+o+" "+m})).append(a("<td/>",{html:l.description,style:"padding-left: 20px"})).appendTo(p)}}}if(e){for(;k<e.length;k++){d=e[k];if(d.optional){h+=" ["+d.name.toUpperCase()+"]"}else{h+=" "+d.name.toUpperCase()}}}g.html(h);p.appendTo(i);return f},init:function(b){var e={callback:a.noop(),cmd:c,commandClass:"command",completedClass:"completed",dividerClass:"divider",errorClass:"error",hiddenFilePrefix:".",hiddenFilePrefixMask:"",hints:".hints",history:[],historyIndex:-1,infoClass:"info",input:'input[type="text"]',inputStash:"",loading:"Loading...",maxHints:-1,messageClass:"message",messageGroupClass:"message-group",optionPrefix:"-",output:".output",prefixOverride:"",prefixSeperator:":",prefixSymbol:"$",username:"",vfsBase:"root",vfsCd:"",vfsDescriptor:"manifest.json",warningClass:"warning",welcomeMessage:"Welcome to jQuery.console!"};return this.each(function(){var c=a(this),f=c.data("console");if(!f){if(b){a.extend(true,e,b)}e.hints=c.find(e.hints).hide();e.input=c.find(e.input);e.output=c.find(e.output);c.data("console",e);f=c.data("console");f.vfsCd=f.vfsCd||f.vfsBase;f.input.bind("keydown.console",d.keyDownHandler);f.input.bind("keyup.console",d.keyUpHandler);if(f.welcomeMessage){c.console("createMessage",f.welcomeMessage,f.infoClass)}f.hints.find("a[data-hint]").live("click.console",function(){f.input.val(a(this).attr("data-hint")+" ").focus();f.hints.hide()}).live("mouseenter.console",function(){a(this).addClass("selected")}).live("mouseleave.console",function(){a(this).removeClass("selected")});f.output.find("a[data-cmd]").live("click.console",function(){var b=a(this);f.inputStash="";f.input.focus();f.input.val(f.input.val());if(b.attr("data-cmd-run")){c.console("send")}else{b.data("console.newcmd",true);c.console("showHints")}}).live("mouseenter.console",function(){f.inputStash=f.input.val();f.input.val(a(this).attr("data-cmd")+" ")}).live("mouseleave.console",function(){var b=a(this);if(b.data("console.newcmd")){b.removeData("console.newcmd")}else{f.input.val(f.inputStash)}f.inputStash=""})}})},keyDownHandler:function(a){switch(a.keyCode){case 38:case 40:a.preventDefault();break;default:}},keyUpHandler:function(b){var c=a(this).console("findConsole"),d=c.data("console");switch(b.keyCode){case 13:if(d.hints.is(":visible")&&d.hints.find(".selected").length){var e=d.hints.find(".selected").attr("data-hint");d.input.val(e+" ");d.hints.hide()}else{c.console("send")}break;case 27:if(d.hints.is(":visible")){d.hints.hide()}else{c.console("showHints")}break;case 38:case 40:var f=b.keyCode===38;if(d.hints.is(":visible")){c.console("navigateHints",f)}else{c.console("searchHistory",f)}break;default:c.console("showHints")}},lookupHints:function(a,b){var c=[],d=this.data("console"),e=[],f=0,g=-1,h=d.cmd,i="";b=b||false;for(;f<a.length;f++){for(i in h){if(h.hasOwnProperty(i)&&i[0]!=="_"){if(i===a[f]){c.push(h[i]);g=f;h=h[i];break}}}if(g!==f){break}}if(c.length===a.length){if(h.hasOwnProperty("_help")){e.push({command:a.join(" "),name:a[g],tip:h._help,usage:this.console("getUsage",h,a[g])})}}else if(c.length===a.length-1){for(i in h){if(h.hasOwnProperty(i)&&i[0]!=="_"){if(i.indexOf(a[a.length-1])===0&&h[i].hasOwnProperty("_help")){if(b||d.maxHints<=0||e.length<=d.maxHints){e.push({command:a.slice(0,a.length-2).join(" ")+" "+i,name:i,tip:h[i]._help,usage:this.console("getUsage",h[i],i)})}}}}}e.sort(function(a,b){return a.name.localeCompare(b.name)});return e},lookupManifest:function(b,c){return this.each(function(){var d=a(this),e=false,f=d.data("console"),g;if(b){if(b.lastIndexOf("/")!==b.length-2||b==="."){b+="/"}if(b.indexOf("~/")===0){e=true}}if(e){b=f.vfsBase+"/"+b.substring(2)+f.vfsDescriptor}else{b=f.vfsCd+"/"+b+f.vfsDescriptor}a.getJSON(b,function(a){g=a}).complete(function(){c.apply(d,[g])})})},printUsage:function(a,b,c){var d=this.data("console"),e=this.console("getUsage",a,b);return this.console("createMessage",e,d.errorClass,c)},navigateHints:function(b){return this.each(function(){var c=a(this).data("console"),d={},e=c.hints.find("a"),f={},g=e.filter(".selected");if(b){d=e.last();f=g.prev()}else{d=e.first();f=g.next()}g.removeClass("selected");if(g.length&&f.length){f.addClass("selected")}else{d.addClass("selected")}})},resetHistorySearch:function(){return this.each(function(){a(this).data("console").historyIndex=-1})},searchHistory:function(b){return this.each(function(){var c=a(this).data("console");if(c.history.length===0){c.historyIndex=-1}else{if(b){if(c.historyIndex===-1){c.historyIndex=c.history.length-1}else{c.historyIndex--;if(c.historyIndex<0){c.historyIndex=0}}}else{if(c.historyIndex!==-1){c.historyIndex++;if(c.historyIndex>=c.history.length){c.historyIndex=-1}}}}if(c.historyIndex===-1){c.input.val("")}else{c.input.val(c.history[c.historyIndex])}})},send:function(){return this.each(function(){var b=a(this),c=[],d=b.data("console"),e="",f=d.input.val()?d.input.val().trim():"";if(f.length){d.input.val("");c=f.split(/\s+/);e=c.join(" ");d.hints.hide();b.console("createMessage",b.console("getPrefix")+" "+e,d.commandClass);b.console("addHistory",e);b.console("callCommand",c)}})},showHints:function(){return this.each(function(){var b=a(this),c=b.data("console"),d=true,e=[],f=0,g=c.input.val()?c.input.val().trim():"";if(g.length){b.console("resetHistorySearch");e=b.console("lookupHints",g.split(/\s+/));if(e.length){c.hints.find("a").remove();c.hints.show();d=false;for(;f<e.length;f++){c.hints.append(a("<a/>",{"data-hint":e[f].command.trim(),tabindex:-1,text:e[f].name}).append(a("<span/>",{text:e[f].tip})))}}}if(d){c.hints.hide()}})}};a.fn.console=function(b){if(d[b]){return d[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return d.init.apply(this,arguments)}else{a.error("Method ["+b+"] does not exist on jQuery.console")}}})(jQuery)